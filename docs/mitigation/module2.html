<!DOCTYPE html>
<html class="no-js" lang="en-US" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<html lang="kr" class="js csstransforms3d">
<head>
  <meta charset="utf-8">
  <meta property="og:title" content="AWS Treat Detection Workshop" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="generator" content="Hugo 0.58.3" />
  <meta name="description" content="AWS Korea Treat Detection Workshop">
<meta name="author" content="Eunsu Shin">

  <link rel="shortcut icon" href="https://a0.awsstatic.com/libra-css/images/site/fav/favicon.ico" type="image/ico" />
<link rel="icon" href="https://a0.awsstatic.com/libra-css/images/site/fav/favicon.ico" type="image/ico" />

  <title>인스턴스 침해 :: AWS Treat Detection Workshop</title>

  
  <link href="../css/nucleus.css" rel="stylesheet">
  <link href="../css/fontawesome-all.min.css" rel="stylesheet">
  <link href="../css/hybrid.css" rel="stylesheet">
  <link href="../css/featherlight.min.css" rel="stylesheet">
  <link href="../css/perfect-scrollbar.min.css" rel="stylesheet">
  <link href="../css/auto-complete.css" rel="stylesheet">
  <link href="../css/atom-one-dark-reasonable.css" rel="stylesheet">
  <link href="../css/theme.css" rel="stylesheet">
  <link href="../css/hugo-theme.css" rel="stylesheet">
  
  <link href="../css/theme-awskr.css" rel="stylesheet">
  

  <script src="../js/jquery-3.3.1.min.js"></script>

  <style>
    :root #header + #content > #left > #rlblock_left{
        display:none !important;
    }
    
      :not(pre) > code + span.copy-to-clipboard {
          display: none;
      }
    
  </style>
  
</head>

<body class="" data-url="/mitigation/module2.html">
  <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <div>
    <a href="../" title="Go home">
        <img style="vertical-align:middle" src="../images/logo.png" height="70px" />
    </a>
</div>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="../js/lunr.min.js"></script>
<script type="text/javascript" src="../js/auto-complete.js"></script>
<script type="text/javascript">
    
        var baseurl = "";
    
</script>
<script type="text/javascript" src="../js/search.js"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/module.html" title="LAB Modules" class="dd-item 
        
        
        
        ">
      <a href="../module.html">
          LAB Modules
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/pre.html" title="실습 개요" class="dd-item 
        
        
        
        ">
      <a href="../pre.html">
          <b>1. </b>실습 개요
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/pre/module1.html" title="실습 안내" class="dd-item ">
        <a href="../pre/module1.html">
        <b>1.1 </b>실습 안내
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/pre/module2.html" title="환경 구성 및 설정" class="dd-item ">
        <a href="../pre/module2.html">
        <b>1.2 </b>환경 구성 및 설정
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/attack.html" title="공격" class="dd-item 
        
        
        
        ">
      <a href="../attack.html">
          <b>2. </b>공격
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/attack/module1.html" title="공격 실행" class="dd-item ">
        <a href="../attack/module1.html">
        <b>2.1 </b>공격 실행
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/mitigation.html" title="탐지 및 분석" class="dd-item 
        parent
        
        
        ">
      <a href="../mitigation.html">
          <b>3. </b>탐지 및 분석
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/mitigation/module1.html" title="자격증명 침해" class="dd-item ">
        <a href="../mitigation/module1.html">
        <b>3.1 </b>자격증명 침해
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/mitigation/module2.html" title="인스턴스 침해" class="dd-item active">
        <a href="../mitigation/module2.html">
        <b>3.2 </b>인스턴스 침해
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/mitigation/module3.html" title="토의" class="dd-item ">
        <a href="../mitigation/module3.html">
        <b>3.3 </b>토의
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/post.html" title="실습 구성 요소 삭제" class="dd-item 
        
        
        
        ">
      <a href="../post.html">
          <b>4. </b>실습 구성 요소 삭제
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/post/module1.html" title="AWS 자원 삭제" class="dd-item ">
        <a href="../post/module1.html">
        <b>4.1 </b>AWS 자원 삭제
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3></h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://github.com/sessin/threatdetection"><i class='fab fa-github'></i> Github repo</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      <left>

    <h5 class="copyright">&copy; 2019 Amazon Web Services, Inc. or its Affiliates. All rights reserved.<h5>

</left>

    </section>
  </div>
</nav>





  <section id="body">
    <div id="overlay"></div>
    <div class="padding highlightable">
      
      <div>
        <div id="top-bar">
          
          
          <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
            <span id="sidebar-toggle-span">
              <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                <i class="fa fa-bars"></i>
              </a>
            </span>
            
            <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
            
            <span class="links">
              
          
          
          
          
          
          
          
          
          
          
          <a href='../'>AWS Threat Detection LAB</a> > <a href='../mitigation.html'>탐지 및 분석</a> > 인스턴스 침해
          
          
          
          
          
          
            </span>
          </div>
          
          <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#2-침해된-ec2-인스턴스">2 - 침해된 EC2 인스턴스</a>
<ul>
<li><a href="#탐지-및-분석-준비">탐지 및 분석 준비</a></li>
<li><a href="#인스터스-id-와-관련된-탐지-내역-분석">인스터스 ID 와 관련된 탐지 내역 분석</a></li>
<li><a href="#ssh-암호-인증이-활성화-되었는지-여부-확인-security-hub">SSH 암호 인증이 활성화 되었는지 여부 확인(Security Hub)</a></li>
<li><a href="#공격자가-ec2-인스턴스에-접속이-가능했었는지-확인-cloudwatch-logs">공격자가 EC2 인스턴스에 접속이 가능했었는지 확인(CloudWatch Logs)</a></li>
<li><a href="#ec2-보안-그룹-설정-변경">EC2 보안 그룹 설정 변경</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

          
        </div>
      </div>
      

      
        <div id="body-inner">
          <h1>인스턴스 침해</h1>
          
          




<h3 id="2-침해된-ec2-인스턴스">2 - 침해된 EC2 인스턴스</h3>

<h4 id="탐지-및-분석-준비">탐지 및 분석 준비</h4>

<p>여러분들은 공격자가 사용하였던 임시보안자격증명을 어떻게 무력화하고 새로운 임시보안자격증명을 발급하여 사용할 수 있는지 학습하였습니다. 이번에는 공격자들이 어떻게 EC2 인스턴스를 침해할 수 있었는지 살펴보도록 하겠습니다. 공격자들은 EC2 인스턴스에 대한 메타데이터 접근 권한이 허용되어 있는 경우 상대적으로 손쉽게 자격증명들을 탈취할 수 있습니다.</p>

<hr />

<h4 id="인스터스-id-와-관련된-탐지-내역-분석">인스터스 ID 와 관련된 탐지 내역 분석</h4>

<p>여러분들이 지난 과정에서 침해당한 IAM 자격증명에 대한 내용을 분석하였을 때 여러분들은 탐지 내역에 EC2 인스턴스 ID 정보가 포함된 Principal ID 와 IAM Role 에 대한 정보를 확인할 수 있었습니다. 이 중 인스턴스 ID 를 사용하면 Security Hub 에서 EC2 와 관련한 탐지 내역들을 선별적으로 분석하실 수 있습니다.</p>


<div class="notices note" ><p>이 과정에서의 분석은 GuardDuty 에 직접 접속해서 수행할 수도 있지만 Security Hub 를 이용한 통합 분석을 경험하는데 그 목적이 있습니다.</p>
</div>


<ol>
<li><a href="https://ap-northeast-2.console.aws.amazon.com/securityhub/home?region=ap-northeast-2#/findings" target="_blank">AWS Security Hub Console</a> 에 접속합니다.<br /></li>
<li>좌측의 &ldquo;분석 결과&rdquo; 메뉴를 클릭합니다.(위 링크를 클릭한 경우 &ldquo;분석 결과&rdquo; 메뉴로 자동접속 됩니다.)
<img src="../images/securityhub_detect1.png" alt="SecurityHub" /><br /></li>
<li>검색창의 &ldquo;필터 추가&rdquo; 부분을 클릭한 후 &ldquo;제품 이름&rdquo; 을 선택한 후 입력창에 &ldquo;GuardDuty&rdquo; 를 입력하고 &ldquo;Apply&rdquo; 버튼을 클릭합니다.
<img src="../images/securityhub_detect2.png" alt="SecurityHub" /><br /></li>
<li>브라우저의 검색 기능 (Control + F) 을 이용하여 이전 과정에서 Principal ID 에서 추출하여 저장해두었던 &ldquo;인스턴스 ID&rdquo; 를 검색합니다.</li>
<li>첫번째 매칭되는 검색항목의 &ldquo;Resource ID&rdquo; 에서 Amazon Resource Name(ARN) 을 복사합니다.
<img src="../images/securityhub_detect3.png" alt="SecurityHub" /></li>
<li>&ldquo;필터 추가&rdquo;를 클릭하여 Resource ID 필터를 하나 더 추가합니다. 조금전에 복사하였던 ARN 을 입력합니다.
<img src="../images/securityhub_detect4.png" alt="SecurityHub" /></li>
</ol>

<p>Security Hub 를 통해 확인할 수 있는 다양한 탐지 내역들을 확인해보면 EC2 인스턴스가 허용되지 말아야할 IP 주소와 통신하고 있었다는 것을 알 수 있습니다. 또한, 외부의 특정 IP 에서 EC2 인스턴스로 SSH 에 대한 Brute Force 공격을 시도하였다는 것을 알 수 있는데요. 여러분들은 이제 해당 EC2 인스턴스에 대한 Brute Foce 공격이 성공하였는지 여부 등을 확인하여야 합니다.</p>

<h4 id="ssh-암호-인증이-활성화-되었는지-여부-확인-security-hub">SSH 암호 인증이 활성화 되었는지 여부 확인(Security Hub)</h4>

<p>자동화된 위협 대응은 여러가지 업무들을 가능하게 합니다. 예를 들어 보안 팀에서 특정 위협이 발생하였을 경우 수작업을 통해 진행하였어야하는 다양한 위협 탐지 관련 정보 수집 작업 등이 대표적일 수 있습니다. 간단한 방법의 하나로, GuardDuty 에서 특정 공격을 탐지했을 경우 CloudWatch 이벤트 규칙을 이용해서 EC2 인스턴스에 설치되어 있는 Inspector 에이전트를 통해 해당 공격과 관련되어 있는 정보들을 탐색하도록 구성할 수 있습니다. 이 실습에서는 Inspector 에서 발견한 사항들을 Security Hub 에서 모니터링 및 관리하는 내용을 살펴보도록 하겠습니다. 우리는 EC2 인스턴스의 SSH 관련 설정이 모범 사례를 따르고 있는지를 확인할 예정입니다.</p>

<ol>
<li><a href="https://ap-northeast-2.console.aws.amazon.com/securityhub/home?region=ap-northeast-2#/findings" target="_blank">AWS Security Hub Console</a> 에 접속합니다.<br /></li>
<li>좌측의 &ldquo;분석 결과&rdquo; 메뉴를 클릭합니다.(위 링크를 클릭한 경우 &ldquo;분석 결과&rdquo; 메뉴로 자동접속 됩니다.)
<img src="../images/securityhub_detect1.png" alt="SecurityHub" /><br /></li>
<li>검색창의 &ldquo;필터 추가&rdquo; 부분을 클릭한 후 &ldquo;제품 이름&rdquo; 을 선택한 후 입력창에 &ldquo;Inspector&rdquo; 를 입력하고 &ldquo;Apply&rdquo; 버튼을 클릭합니다.
<img src="../images/securityhub_detect5.png" alt="SecurityHub" /><br /></li>
<li>브라우저의 검색 기능 (Control + F) 을 이용하여 &ldquo;password authentication over SSH&rdquo; 를 검색합니다.
<img src="../images/securityhub_detect6.png" alt="SecurityHub" />

<div class="notices note" ><p>페이지의 첫번째 화면에 검색 내용이 없는 경우 &ldquo;&gt;&rdquo; 버튼을 이용하여 다음 페이지에서 검색하시기 바랍니다.</p>
</div>
</li>
<li>SSH 및 패스워드 인증과 관련한 탐지 내역을 클릭합니다.
<img src="../images/securityhub_detect7.png" alt="SecurityHub" />

<div class="notices tip" ><p>password authentication over SSH 과 관련한 취약점을 Inspector 가 발견한 것으로 미루어 해당 EC2 인스턴스에 Password 기반 인증 기능이 활성화되어 있는 것으로 판단됩니다. Password 에 기반한 인증은 SSH Key Pair 기반의 인증보다 보안위 취약하기 때문에 비활성화하는 것을 권고합니다.</p>
</div>
</li>
</ol>

<h4 id="공격자가-ec2-인스턴스에-접속이-가능했었는지-확인-cloudwatch-logs">공격자가 EC2 인스턴스에 접속이 가능했었는지 확인(CloudWatch Logs)</h4>

<ol>
<li><a href="https://ap-northeast-2.console.aws.amazon.com/cloudwatch/home?region=ap-northeast-2#logs:" target="_blank">AWS CloudWatch Console</a> 에 접속합니다.<br /></li>
<li>좌측의 &ldquo;로그 그룹&rdquo; 메뉴를 클릭합니다.(위 링크를 클릭한 경우 &ldquo;로그 그룹&rdquo; 메뉴로 자동접속 됩니다.)
<img src="../images/cloudwatch1.png" alt="CloudWatch" /><br /></li>
<li><code>/threat-detection-wksp/var/log/secure</code> 로그 그룹을 선택합니다.
<img src="../images/cloudwatch2.png" alt="CloudWatch" /><br /></li>
<li>로그 그룹을 클릭하면 여러개의 로그 스트림이 있는 것을 확인할 수 있습니다. 이전 과정에서 복사해 두었던 인스턴스 ID 에 해당하는 로그 스트림을 찾아서 클릭합니다.
<img src="../images/cloudwatch3.png" alt="CloudWatch" /><br /></li>

<li><p>&ldquo;이벤트 필터링&rdquo; 부분에 아래의 필터 조건을 입력합니다.</p>

<pre><code>[Mon, day, timestamp, ip, id, msg1= Invalid, msg2 = user, ...]
</code></pre>

<p><img src="../images/cloudwatch4.png" alt="CloudWatch" />
아래와 같이 필터 적용 후 결과를 확인합니다.
<img src="../images/cloudwatch5.png" alt="CloudWatch" />

<div class="notices tip" ><p>필터를 적용 후 확인해보면 다수의 SSH 접속 시도가 있었음을 확인할 수 있습니다. 즉, 해당 인스턴스에 대해 Brute Force 공격이 있었음을 확인할 수 있습니다.</p>
</div>
</p></li>

<li><p>이번에는 아래와 같이 약간 수정된 이벤트 필터를 적용합니다.</p>

<pre><code>[Mon, day, timestamp, ip, id, msg1= Accepted, msg2 = password, ...]
</code></pre>

<p>아래와 같이 필터 적용 후 결과를 확인합니다.
<img src="../images/cloudwatch6.png" alt="CloudWatch" />

<div class="notices tip" ><p>이번에는 SSH 접근이 허용된 로그들을 확인할 수 있습니다. 즉, 공격자가 Brute Force 공격을 통해 해당 인스턴스에 정상적으로 접속하였음을 확인할 수 있습니다.</p>
</div>
</p></li>
</ol>

<h4 id="ec2-보안-그룹-설정-변경">EC2 보안 그룹 설정 변경</h4>

<ol>
<li><a href="https://ap-northeast-2.console.aws.amazon.com/ec2/v2/home?region=us-west-2#Instances:sort=instanceId" target="_blank">AWS EC2 Console</a> 에 접속합니다.<br /></li>
<li>threat-detection-wksp: Compromised Instance 라는 이름의 EC2 인스턴스를 선택합니다.
<img src="../images/securitygroup1.png" alt="SecurityGroup" /><br /></li>
<li>화면 하단의 &ldquo;설명&rdquo; 탭에서 해당 인스턴스가 사용중인 보안그룹을 선택합니다.
<img src="../images/securitygroup2.png" alt="SecurityGroup" /><br /></li>
<li>&ldquo;인바운드&rdquo; 탭을 선택한 후 &ldquo;편집&rdquo; 버튼을 클릭합니다.
<img src="../images/securitygroup3.png" alt="SecurityGroup" /><br /></li>
<li>인바운드 SSH 규칙을 삭제한 후 &ldquo;저장&rdquo; 버튼을 클릭합니다.
<img src="../images/securitygroup4.png" alt="SecurityGroup" /></li>
</ol>


<div class="notices note" ><p>Brute Force 공격을 통해 침해되었던 EC2 인스턴스에 할당되어 있던 인바운드 SSH 규칙이 삭제되었기 때문에 이제 외부에서 EC2 인스턴스로의 SSH Brute Force 공격 시도는 원천 차단되었습니다.</p>
</div>


<blockquote>

<a  class="btn btn-default">
  
  
  
    
  <i class="fas fa-asterisk"></i>
    
  
  아래는 침해 사고 분석 결과가 반영된 공격 분석 및 대응 입니다.
  
</a>

</blockquote>

<p><img src="../images/formation_architecture2.png" alt="Architecture" /></p>


<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="../mitigation/module1.html" title="자격증명 침해"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="../mitigation/module3.html" title="토의" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="../js/clipboard.min.js"></script>
    <script src="../js/perfect-scrollbar.min.js"></script>
    <script src="../js/perfect-scrollbar.jquery.min.js"></script>
    <script src="../js/jquery.sticky.js"></script>
    <script src="../js/featherlight.min.js"></script>
    <script src="../js/html5shiv-printshiv.min.js"></script>
    <script src="../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="../js/modernizr.custom-3.6.0.js"></script>
    <script src="../js/learn.js"></script>
    <script src="../js/hugo-learn.js"></script>

    <link href="../mermaid/mermaid.css" rel="stylesheet" />
    <script src="../mermaid/mermaid.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    
  </body>
</html>

